<!DOCTYPE html>
<html lang="nl">
<head>
      <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pigeon Legends - Training</title>
    <link rel="icon" type="image/png" href="Duif1.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --primary-color: #3b82f6;
      --primary-dark: #2563eb;
      --secondary-color: #10b981;
      --accent-color: #f59e0b;
      --danger-color: #ef4444;
      --text-primary: #1f2937;
      --text-secondary: #6b7280;
      --bg-primary: #ffffff;
      --bg-secondary: #f8fafc;
      --bg-tertiary: #f1f5f9;
      --border-color: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 50%, #e0f2fe 100%);
      background-attachment: fixed;
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Duiven achtergrond decoratie */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        radial-gradient(circle at 20% 20%, rgba(59, 130, 246, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(16, 185, 129, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 40% 60%, rgba(245, 158, 11, 0.02) 0%, transparent 50%);
      pointer-events: none;
      z-index: -1;
    }

    /* Vliegende duiven animatie */
    @keyframes fly {
      0% { transform: translateX(-100px) translateY(0px) rotate(0deg); opacity: 0; }
      10% { opacity: 0.3; }
      90% { opacity: 0.3; }
      100% { transform: translateX(calc(100vw + 100px)) translateY(-50px) rotate(5deg); opacity: 0; }
    }

    .flying-dove {
      position: fixed;
      font-size: 2rem;
      color: rgba(59, 130, 246, 0.1);
      animation: fly 15s linear infinite;
      pointer-events: none;
      z-index: -1;
    }

    .flying-dove:nth-child(1) { top: 15%; animation-delay: 0s; }
    .flying-dove:nth-child(2) { top: 35%; animation-delay: 5s; }
    .flying-dove:nth-child(3) { top: 55%; animation-delay: 10s; }
    .flying-dove:nth-child(4) { top: 75%; animation-delay: 3s; }
    .flying-dove:nth-child(5) { top: 25%; animation-delay: 8s; }



    /* Header */
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      padding: 1rem 2rem;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: var(--shadow-sm);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1.5rem;
    }

    .back-button {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 0.5rem 1rem;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .back-button:hover {
      background: var(--bg-secondary);
      box-shadow: var(--shadow-md);
      transform: translateY(-1px);
    }

    .page-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .page-title i {
      color: var(--accent-color);
      font-size: 1.75rem;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .time-display-header {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
    }

    .time-text-header {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .weather-display-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 8px;
      padding: 0.5rem 1rem;
      border: 1px solid var(--border-color);
    }

    .weather-icon-header {
      font-size: 1.25rem;
    }

    .weather-temp-header {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .weather-desc-header {
      color: var(--text-secondary);
      font-size: 0.8rem;
    }
    
    .weather-time-header {
      font-size: 0.7rem;
      color: var(--text-secondary);
      margin-left: 0.5rem;
      font-weight: 500;
    }
    
    .weather-day-header {
      font-size: 0.65rem;
      color: var(--text-secondary);
      margin-left: 0.5rem;
      font-style: italic;
    }

    /* Main Content */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
    }



    /* Training Content */
    .training-content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 2rem;
    }

    .training-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow-xl);
      transition: all 0.3s ease;
    }

    .training-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.25);
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 1rem;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border-color);
    }

    .card-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
      color: white;
      background: linear-gradient(135deg, var(--accent-color), #d97706);
    }

    .card-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    /* Flight Detail */
    .vlucht-detail {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 16px;
      padding: 2rem;
      box-shadow: var(--shadow-xl);
      position: relative;
      overflow: hidden;
    }

    .vlucht-detail::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--accent-color), var(--secondary-color));
    }

    .detail-controls {
      position: absolute;
      top: 1rem;
      right: 1rem;
      display: flex;
      gap: 0.5rem;
    }

    .detail-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-sm);
      border: none;
    }

    .minimize-btn {
      background: var(--accent-color);
      color: white;
    }

    .minimize-btn:hover {
      background: #d97706;
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
    }

    .close-detail {
      background: var(--danger-color);
      color: white;
    }

    .close-detail:hover {
      background: #dc2626;
      transform: scale(1.1);
      box-shadow: var(--shadow-md);
    }

    .vlucht-header {
      margin-bottom: 1.5rem;
    }

    .vlucht-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }

    .vlucht-subtitle {
      font-size: 1rem;
      color: var(--text-secondary);
      margin-bottom: 1rem;
    }

    .status-label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 1.5rem;
    }

    .status-label.actief {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-label.voltooid {
      background: #dbeafe;
      color: #1e40af;
      border: 1px solid #bfdbfe;
    }

    .status-label.gepland {
      background: #fef3c7;
      color: #92400e;
      border: 1px solid #fde68a;
    }

    /* Control Buttons */
    .control-buttons {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap;
    }

    .control-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: var(--shadow-sm);
    }

    .control-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .control-btn.start {
      background: var(--secondary-color);
      color: white;
    }

    .control-btn.start:hover:not(:disabled) {
      background: #059669;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .control-btn.stop {
      background: var(--accent-color);
      color: white;
    }

    .control-btn.stop:hover:not(:disabled) {
      background: #d97706;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .control-btn.reset {
      background: var(--danger-color);
      color: white;
    }

    .control-btn.reset:hover:not(:disabled) {
      background: #dc2626;
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .control-btn.fast-forward {
      background: linear-gradient(135deg, #8b5cf6, #7c3aed);
      color: white;
    }

    .control-btn.fast-forward:hover:not(:disabled) {
      background: linear-gradient(135deg, #7c3aed, #6d28d9);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .progress-container {
      margin: 1rem 0;
    }

    .progress-bar {
      width: 100%;
      height: 12px;
      background: var(--bg-secondary);
      border-radius: 8px;
      overflow: hidden;
      border: 1px solid var(--border-color);
    }

    .progress-fill {
      height: 100%;
      border-radius: 8px;
      transition: width 0.5s ease;
    }

    /* Form Styling */
    .form-section {
      margin-bottom: 2rem;
    }

    .form-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

            .duiven-lijst {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
          gap: 0.4rem;
          margin-bottom: 1.5rem;
        }

    .duif-checkbox-label {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .duif-checkbox-label:hover {
      background: var(--bg-tertiary);
      border-color: var(--primary-color);
    }

    .duif-checkbox-label input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary-color);
    }

    .duif-info {
      flex: 1;
    }

    .duif-naam {
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .duif-details {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .duif-geslacht {
      font-size: 1.2rem;
    }

    .duif-geslacht.mannetje { color: #3b82f6; }
    .duif-geslacht.vrouwtje { color: #ec4899; }

    .submit-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      box-shadow: var(--shadow-sm);
    }

    .submit-btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      background: linear-gradient(135deg, var(--secondary-color), #059669);
      color: white;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: var(--shadow-md);
      border: none;
      cursor: pointer;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
    }

    /* Race Table */
    .race-table {
      background: var(--bg-primary);
      border-radius: 12px;
      overflow: hidden;
      box-shadow: var(--shadow-lg);
      margin-top: 1.5rem;
    }

    .race-header {
      background: var(--bg-secondary);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--border-color);
    }

    .race-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .race-table table {
      width: 100%;
      border-collapse: collapse;
    }

    .race-table th {
      background: var(--bg-tertiary);
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 0.875rem;
      border-bottom: 1px solid var(--border-color);
    }

    .race-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      font-size: 0.875rem;
    }

    .race-table tr:hover {
      background: var(--bg-secondary);
    }

    .position {
      font-weight: 700;
      text-align: center;
      width: 60px;
    }

    .position.medal {
      font-size: 1.2rem;
    }

    .position.medal.gold { color: #fbbf24; }
    .position.medal.silver { color: #9ca3af; }
    .position.medal.bronze { color: #d97706; }

    .duif-naam-cell {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .duif-geslacht-cell {
      font-size: 1.2rem;
    }

    .speed-cell {
      font-weight: 600;
      color: var(--secondary-color);
    }

    .progress-container {
      width: 100%;
      background: var(--bg-tertiary);
      border-radius: 8px;
      overflow: hidden;
      height: 8px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--secondary-color), var(--primary-color));
      border-radius: 8px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-top: 0.25rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        gap: 1rem;
      }

      .main-container {
        padding: 1rem;
      }

      .status-bar {
        flex-direction: column;
        align-items: flex-start;
      }

      .control-buttons {
        flex-direction: column;
      }

      .duiven-lijst {
        grid-template-columns: 1fr;
      }

      .race-table {
        overflow-x: auto;
      }

      .race-table table {
        min-width: 600px;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 1rem;
      }

      .training-card,
      .vlucht-detail {
        padding: 1.5rem;
      }

      .card-header {
        flex-direction: column;
        text-align: center;
      }
    }

    /* Notification Styles */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #fff;
      color: var(--text-primary);
      padding: 15px 25px;
      border-radius: 8px;
      box-shadow: var(--shadow-md);
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
      transition: opacity 0.5s ease-in-out;
      z-index: 1000;
    }

    .notification.show {
      opacity: 1;
    }

    .notification.success {
      background-color: #d1fae5;
      border: 1px solid #a7f3d0;
    }

    .notification.error {
      background-color: #fee2e2;
      border: 1px solid #fca5a5;
    }

    .notification.warning {
      background-color: #fef3c7;
      border: 1px solid #fde68a;
    }

    .notification.info {
      background-color: #e0f2fe;
      border: 1px solid #bfdbfe;
    }

    .notification i {
      font-size: 1.25rem;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: scale(0.98); }
      to { opacity: 1; transform: scale(1); }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <div class="header-left">
        <a href="dashboard.html" class="back-button" id="back-link">
          <i class="fas fa-arrow-left"></i>
                      <span data-translate="back">Hoofdpagina</span>
        </a>
        <h1 class="page-title">
          <i class="fas fa-dove"></i>
          <span data-translate="training">Training</span>
        </h1>
      </div>
      <div class="header-right">
        <div class="time-display-header">
          <span id="currentTimeHeader" class="time-text-header"></span>
        </div>
                    <div class="weather-display-header">
              <span id="weatherIconHeader" class="weather-icon-header"></span>
              <span id="weatherTempHeader" class="weather-temp-header"></span>
              <span id="weatherDescHeader" class="weather-desc-header"></span>
              <span id="weatherTimeHeader" class="weather-time-header"></span>
              <span id="weatherDayHeader" class="weather-day-header"></span>
            </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-container">
    
    <!-- Nieuwe Training Knop -->
    <div id="nieuweTrainingKnop" style="margin-bottom: 2rem; display:none;">
      <a href="nieuwe_training.html" class="btn-primary">
        <i class="fas fa-plus-circle"></i>
        Nieuwe Training Maken
      </a>
    </div>

    <!-- Training Content -->
    <div class="training-content" id="trainingContent">
      <!-- Content will be loaded here -->
    </div>

  </main>

  <!-- Vliegende duiven achtergrond -->
  <div class="flying-dove">ðŸ•Šï¸</div>
  <div class="flying-dove">ðŸ•Šï¸</div>
  <div class="flying-dove">ðŸ•Šï¸</div>
  <div class="flying-dove">ðŸ•Šï¸</div>
  <div class="flying-dove">ðŸ•Šï¸</div>

  <!-- Duif Profiel Popup -->
  <div id="duifProfielPopup" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.4);z-index:9999;align-items:center;justify-content:center;"></div>

  
  <script type="module">
    // Supabase client import
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
    import './weather.js';
    import './training-background.js';
    
            // Check authenticatie
        const isAuthenticated = localStorage.getItem('user_authenticated');
        const userEmail = localStorage.getItem('user_email');
        const isRedirecting = localStorage.getItem('redirecting');

        // Verwijder redirect flag
        localStorage.removeItem('redirecting');

        if (isAuthenticated !== 'true' || !userEmail) {
            if (!isRedirecting) {
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 100);
            }
        }

        const supabase = createClient('https://ltwolxjbmdopjslnlkx.supabase.co', 'sb_publishable_-hFbgnkMK4xn3uAaqJEuxA_C_9HAV6e');

    let vlucht = null;
    let trainingInterval = null;
    let fastForwardMode = 0; // 0 = normaal, 1 = 2x, 2 = 5x, 3 = 10x



    // Tijd functie
    function updateTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString('nl-NL', { 
        hour: '2-digit', 
        minute: '2-digit',
        timeZone: 'Europe/Amsterdam'
      });
      
      const timeHeader = document.getElementById('currentTimeHeader');
      if (timeHeader) {
        timeHeader.textContent = timeString;
      }
    }

    async function updateWeather() {
      try {
        // Use shared weather manager
        if (window.weatherManager) {
          window.weatherManager.updateWeatherDisplay();
        }
      } catch (error) {
        console.error('Weer update fout:', error);
      }
    }

    // Update tijd elke seconde, weer elke 5 minuten
    setInterval(updateTime, 1000);
    setInterval(updateWeather, 300000);
    updateTime();
    updateWeather();
    
    // Ensure weather is displayed immediately
    if (window.weatherManager) {
      window.weatherManager.updateWeatherDisplay();
    }

    // Load training data
    async function loadTrainingData() {
      try {
        // Haal alle trainingsvluchten op, gesorteerd op datum en naam voor consistente volgorde
        const { data: vluchten, error } = await supabase
          .from('trainingsvluchten')
          .select('*')
          .order('datum', { ascending: true })
          .order('naam', { ascending: true });
        
        if (error) {
          console.error('Fout bij laden trainingsvluchten:', error);
          document.getElementById('trainingContent').innerHTML = `
            <div class="error-message" style="text-align: center; padding: 2rem; color: var(--error-color);">
              <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
              <h3>Fout bij laden trainingsvluchten</h3>
              <p>Er is een probleem opgetreden bij het laden van de trainingsgegevens.</p>
            </div>
          `;
          return;
        }
        
        let content = '';
        
        // Training selector voor alle accounts
        if (vluchten && vluchten.length > 0) {
          // Herstel geselecteerde training uit localStorage, anders standaard de actieve
          const selectedTrainingId = localStorage.getItem('selectedTrainingId');
          let geselecteerdeVlucht = vluchten.find(v => v.id === selectedTrainingId);
          
          if (!geselecteerdeVlucht) {
            // Als geen geselecteerde training, gebruik actieve of eerste
            geselecteerdeVlucht = vluchten.find(v => v.status === 'actief') || vluchten[0];
            if (geselecteerdeVlucht) {
              localStorage.setItem('selectedTrainingId', geselecteerdeVlucht.id);
            }
          }
          
          const nieuwste = geselecteerdeVlucht;
          
          content += `
            <div class="training-selector" style="margin-bottom: 2rem; background: var(--bg-secondary); border-radius: 8px; padding: 1rem;">
              <h3 style="margin-bottom: 1rem; color: var(--text-primary);">
                <i class="fas fa-list"></i> Kies Training
              </h3>
              <select id="trainingSelector" onchange="selectTraining(this.value)" style="
                width: 100%;
                padding: 0.75rem;
                border: 1px solid var(--border-color);
                border-radius: 6px;
                background: white;
                font-size: 1rem;
                color: var(--text-primary);
              ">
                <option value="">Selecteer een training...</option>
                ${vluchten.map(vlucht => `
                  <option value="${vlucht.id}" ${vlucht.id === nieuwste.id ? 'selected' : ''}>
                    ${vlucht.naam} (${vlucht.afstand_km} km) - ${vlucht.status.charAt(0).toUpperCase() + vlucht.status.slice(1)}
                  </option>
                `).join('')}
              </select>
            </div>
          `;
          content += `
            <div class="training-card">
              <div class="card-header">
                <div class="card-icon">
                  <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <!-- Oranje achtergrond met afgeronde hoeken -->
                    <rect x="2" y="2" width="28" height="28" rx="8" fill="#ea580c"/>
                    <!-- Lichtere oranje vliegende duif -->
                    <path d="M10 18C10 18 13 12 16 12C19 12 22 18 22 18L20 20C20 20 18 18 16 18C14 18 12 20 12 20L10 18Z" fill="#f97316"/>
                    <ellipse cx="16" cy="22" rx="3" ry="2" fill="#f97316"/>
                    <circle cx="16" cy="16" r="1.5" fill="#f97316"/>
                    <circle cx="17" cy="15" r="0.4" fill="#ffffff"/>
                  </svg>
                </div>
                <h2 class="card-title">Mijn Trainingsvlucht</h2>
              </div>
              <div style="display: grid; gap: 1rem;">
                  <div class="vlucht-item" onclick="openVluchtDetail('${nieuwste.id}')" style="
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-color);
                    border-radius: 8px;
                    padding: 1.5rem;
                    cursor: pointer;
                    transition: all 0.2s ease;
                  " onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                      <div>
                        <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                          ${nieuwste.naam}
                        </h3>
                        <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                          ${nieuwste.start_locatie} â†’ ${nieuwste.eind_locatie}
                        </p>
                        <div style="display: flex; gap: 1rem; font-size: 0.875rem;">
                          <span style="color: var(--text-secondary);">
                            <i class="fas fa-ruler" style="margin-right: 0.25rem;"></i>
                            ${nieuwste.afstand_km} km
                          </span>
                          <span style="color: var(--text-secondary);">
                            <i class="fas fa-calendar" style="margin-right: 0.25rem;"></i>
                            ${new Date(nieuwste.datum).toLocaleDateString('nl-NL')}
                          </span>
                        </div>
                      </div>
                      <div style="text-align: right;">
                        <div class="status-label ${nieuwste.status}" style="margin-bottom: 0.5rem;">
                          <i class="fas fa-${nieuwste.status === 'actief' ? 'play' : nieuwste.status === 'voltooid' ? 'check' : 'clock'}"></i>
                          ${nieuwste.status.charAt(0).toUpperCase() + nieuwste.status.slice(1)}
                        </div>
                        <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                      </div>
                    </div>
                  </div>
              </div>
            </div>
          `;
        }
        
        // No flights available
        if (!vluchten || vluchten.length === 0) {
          content = `
            <div class="training-card">
              <div class="card-header">
                <div class="card-icon">
                  <i class="fas fa-plus-circle"></i>
                </div>
                <h2 class="card-title">Nog Geen Trainingsvluchten</h2>
              </div>
              <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 4rem; color: var(--text-secondary); margin-bottom: 1rem;">
                  ðŸ•Šï¸
                </div>
                <h3 style="color: var(--text-primary); margin-bottom: 1rem; font-size: 1.25rem;">
                  Maak je eerste training aan!
                </h3>
                <p style="color: var(--text-secondary); line-height: 1.6; margin-bottom: 2rem;">
                  Klik op "Nieuwe Training Maken" bovenaan de pagina om je eerste trainingsvlucht te creÃ«ren en te simuleren.
                </p>
              </div>
            </div>
          `;
        }
        
        document.getElementById('trainingContent').innerHTML = content;
      } catch (error) {
        console.error('Error loading training data:', error);
        showNotification('Fout bij laden trainingsvluchten', 'error');
      }
    }

    // Select training function
    window.selectTraining = async function(vluchtId) {
      if (!vluchtId) return;
      
      try {
        const { data: vlucht, error } = await supabase
          .from('trainingsvluchten')
          .select('*')
          .eq('id', vluchtId)
          .single();
        
        if (error) {
          showNotification('Fout bij laden training: ' + error.message, 'error');
          return;
        }
        
        // Sla geselecteerde training op in localStorage
        localStorage.setItem('selectedTrainingId', vluchtId);
        
        // Update de training card met de geselecteerde training
        updateTrainingCard(vlucht);
        
      } catch (error) {
        console.error('Fout bij selecteren training:', error);
        showNotification('Fout bij selecteren training', 'error');
      }
    }

    // Update training card
    function updateTrainingCard(vlucht) {
      const trainingCard = document.querySelector('.training-card');
      if (!trainingCard) return;
      
      trainingCard.innerHTML = `
        <div class="card-header">
          <div class="card-icon">
            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="2" y="2" width="28" height="28" rx="8" fill="#ea580c"/>
              <path d="M10 18C10 18 13 12 16 12C19 12 22 18 22 18L20 20C20 20 18 18 16 18C14 18 12 20 12 20L10 18Z" fill="#f97316"/>
              <ellipse cx="16" cy="22" rx="3" ry="2" fill="#f97316"/>
              <circle cx="16" cy="16" r="1.5" fill="#f97316"/>
              <circle cx="17" cy="15" r="0.4" fill="#ffffff"/>
            </svg>
          </div>
          <h2 class="card-title">Geselecteerde Training</h2>
        </div>
        <div style="display: grid; gap: 1rem;">
            <div class="vlucht-item" onclick="openVluchtDetail('${vlucht.id}')" style="
              background: var(--bg-secondary);
              border: 1px solid var(--border-color);
              border-radius: 8px;
              padding: 1.5rem;
              cursor: pointer;
              transition: all 0.2s ease;
            " onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='var(--bg-secondary)'">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h3 style="font-size: 1.125rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">
                    ${vlucht.naam}
                  </h3>
                  <p style="color: var(--text-secondary); margin-bottom: 0.5rem;">
                    ${vlucht.start_locatie} â†’ ${vlucht.eind_locatie}
                  </p>
                  <div style="display: flex; gap: 1rem; font-size: 0.875rem;">
                    <span style="color: var(--text-secondary);">
                      <i class="fas fa-ruler" style="margin-right: 0.25rem;"></i>
                      ${vlucht.afstand_km} km
                    </span>
                    <span style="color: var(--text-secondary);">
                      <i class="fas fa-calendar" style="margin-right: 0.25rem;"></i>
                      ${new Date(vlucht.datum).toLocaleDateString('nl-NL')}
                    </span>
                  </div>
                </div>
                <div style="text-align: right;">
                  <div class="status-label ${vlucht.status}" style="margin-bottom: 0.5rem;">
                    <i class="fas fa-${vlucht.status === 'actief' ? 'play' : vlucht.status === 'voltooid' ? 'check' : 'clock'}"></i>
                    ${vlucht.status.charAt(0).toUpperCase() + vlucht.status.slice(1)}
                  </div>
                  <i class="fas fa-chevron-right" style="color: var(--text-secondary);"></i>
                </div>
              </div>
            </div>
        </div>
      `;
    }

    // Open flight detail
    window.openVluchtDetail = async function(vluchtId) {
      try {
        const { data: vlucht, error } = await supabase
          .from('trainingsvluchten')
          .select('*')
          .eq('id', vluchtId)
          .single();

        if (error) throw error;
        if (!vlucht) {
          showNotification('Trainingsvlucht niet gevonden', 'error');
          return;
        }

        await laadVluchtDetail(vlucht);
      } catch (error) {
        console.error('Error opening flight detail:', error);
        showNotification('Fout bij openen trainingsvlucht', 'error');
      }
    }

    // Load flight detail with improved duiven selection
    async function laadVluchtDetail(vlucht) {
      try {
        console.log('ðŸ” Laden vlucht detail voor:', vlucht.id);
        
        // Haal duiven op die in vliegkooien zitten
        const { data: vliegkooien, error: kooiError } = await supabase
          .from('kooien')
          .select('id')
          .eq('type', 'vliegkooi');

        if (kooiError) {
          console.error('âŒ Fout bij ophalen vliegkooien:', kooiError);
          showNotification('Fout bij ophalen vliegkooien', 'error');
          return;
        }

        if (!vliegkooien || vliegkooien.length === 0) {
          showNotification('Geen vliegkooien beschikbaar. Maak eerst vliegkooien aan in de Duiventil.', 'warning');
          return;
        }

        console.log('ðŸ“¦ Vliegkooien gevonden:', vliegkooien.length);

        // Haal huidige gebruiker op
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) {
          showNotification('Je moet ingelogd zijn om trainingen te bekijken', 'error');
          return;
        }
        const currentUserId = user.id;

        // Haal alleen eigen duiven op voor inschrijving
        const { data: duiven, error: duifError } = await supabase
          .from('duiven')
          .select('*, users!duiven_user_id_fkey(team_naam)')
          .eq('user_id', currentUserId)
          .order('naam');

        if (duifError) {
          console.error('âŒ Fout bij ophalen duiven:', duifError);
          showNotification('Fout bij ophalen duiven', 'error');
          return;
        }

        console.log('ðŸ•Šï¸ Duiven gevonden:', duiven?.length || 0);

        if (!duiven || duiven.length === 0) {
          showNotification('Geen duiven in vliegkooien. Plaats eerst duiven in vliegkooien.', 'warning');
          return;
        }

        // Haal huidige deelnemers op met uitgebreide logging
        console.log('ðŸ” Ophalen deelnemers voor vlucht:', vlucht.id);
        const { data: deelnemers, error: deelnemerError } = await supabase
          .from('trainingsvlucht_deelnames')
          .select('*, duiven!fk_duif(*, users!duiven_user_id_fkey(team_naam))')
          .eq('trainingsvlucht_id', vlucht.id);

        if (deelnemerError) {
          console.error('âŒ Fout bij ophalen deelnemers:', deelnemerError);
          showNotification('Fout bij ophalen deelnemers: ' + deelnemerError.message, 'error');
          return;
        }

        console.log('ðŸ“Š Deelnemers gevonden:', deelnemers?.length || 0);
        if (deelnemers && deelnemers.length > 0) {
          console.log('ðŸ“‹ Deelnemers details:', deelnemers.map(d => ({
            id: d.id,
            duif_id: d.duif_id,
            duif_naam: d.duiven?.naam,
            status: d.status
          })));
        }

        const ingeschrevenIds = deelnemers ? deelnemers.map(d => d.duif_id) : [];
        
        // Maak duivenlijst met eigenschappen
        const lijst = duiven.map(duif => {
          const leeftijdJaren = Math.floor(duif.leeftijd_maanden / 12);
          const leeftijdMaanden = duif.leeftijd_maanden % 12;
          const leeftijdTekst = leeftijdJaren > 0 ? `${leeftijdJaren}j ${leeftijdMaanden}m` : `${leeftijdMaanden}m`;
          const geslachtClass = duif.geslacht === 'man' ? 'duif-man' : 'duif-vrouw';
          const isIngeschreven = ingeschrevenIds.includes(duif.id);
          const isVliegend = vlucht.status === 'actief' && isIngeschreven;
          const isEigenDuif = true; // Alle duiven zijn nu eigen duiven
          const teamNaam = duif.users?.team_naam || 'Onbekend Team';
          
          // Bepaal achtergrondkleur - lichtere kleuren
          let bgColor = duif.geslacht === 'man' ? '#eff6ff' : '#fdf2f8'; // Lichtblauw voor mannen, lichtroze voor vrouwen
          if (isVliegend) {
            bgColor = duif.geslacht === 'man' ? '#dbeafe' : '#fce7f3'; // Iets donkerder voor vliegende duiven
          }
          
          // Bereken totaal eigenschappen
          const totaalEigenschappen = (duif.vormpeil || 0) + (duif.snelheid || 0) + (duif.conditie || 0) + (duif.orientatie || 0) + 
                                     (duif.techniek || 0) + (duif.ervaring || 0) + (duif.aerodynamica || 0) + (duif.intelligentie || 0) + (duif.nachtvliegen || 0);
          
          // Mooiere libido weergave
          const libidoHearts = 'â¤ï¸'.repeat(duif.libido || 0);
          const libidoDisplay = duif.libido > 0 ? `<span style="color:#ec4899;font-size:0.8rem;">${libidoHearts}</span>` : '<span style="color:#9ca3af;font-size:0.8rem;">ðŸ’”</span>';
          
          return `
            <label class="duif-checkbox-label ${geslachtClass}" style="
              background:${bgColor};
              border-radius:8px;
              padding:0.75rem;
              margin:0.3rem;
              display:inline-block;
              min-width:180px;
              cursor:pointer;
              border:2px solid ${isIngeschreven ? '#10b981' : duif.geslacht === 'man' ? '#3b82f6' : '#ec4899'};
              position:relative;
              transition:all 0.2s ease;
              ${isVliegend ? 'box-shadow:0 2px 8px rgba(16,185,129,0.2);' : ''}
              ${isEigenDuif ? 'border-left:4px solid #10b981;' : ''}
            ">
              <input type="checkbox" class="duif-checkbox" value="${duif.id}" ${isIngeschreven ? 'checked' : ''}>
              
              <!-- Duif header -->
              <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;">
                <span class="duif-geslacht ${duif.geslacht}" style="font-size:1rem;color:${duif.geslacht === 'man' ? '#3b82f6' : '#ec4899'};">
                  ${duif.geslacht === 'man' ? 'â™‚' : 'â™€'}
                </span>
                <span class="duif-naam-link" style="font-weight:600;font-size:0.9rem;color:#1f2937;cursor:pointer;text-decoration:underline;" onclick="toonDuifProfiel('${duif.id}')">
                  ${duif.naam}
                </span>
                ${isEigenDuif ? '<span style="color:#10b981;font-size:0.7rem;font-weight:600;">(Jouw)</span>' : ''}
              </div>
              
              <!-- Team naam -->
              <div style="font-size:0.7rem;color:#6b7280;margin-bottom:0.3rem;font-weight:500;">
                ðŸ† ${teamNaam}
              </div>
              
              <!-- Duif details -->
              <div style="font-size:0.75rem;color:#6b7280;margin-bottom:0.5rem;">
                ${leeftijdTekst} â€¢ ${totaalEigenschappen} punten
              </div>
              
              <!-- Libido -->
              <div style="margin-bottom:0.5rem;">
                ${libidoDisplay}
              </div>
              
              <!-- Eigenschappen grid -->
              <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.3rem;font-size:0.7rem;">
                <div style="color:#6b7280;">âš¡ ${duif.snelheid || 0}</div>
                <div style="color:#6b7280;">ðŸ’ª ${duif.conditie || 0}</div>
                <div style="color:#6b7280;">ðŸ§­ ${duif.oriÃ«ntatie || 0}</div>
                <div style="color:#6b7280;">ðŸŽ¯ ${duif.techniek || 0}</div>
                <div style="color:#6b7280;">ðŸ“š ${duif.ervaring || 0}</div>
                <div style="color:#6b7280;">âœˆï¸ ${duif.aerodynamica || 0}</div>
                <div style="color:#6b7280;">ðŸ§  ${duif.intelligentie || 0}</div>
                <div style="color:#6b7280;">ðŸŒ™ ${duif.nachtvliegen || 0}</div>
              </div>
              
              <!-- Status indicators -->
              ${isIngeschreven ? '<span style="color:#10b981;font-size:0.65rem;margin-top:0.5rem;display:block;">âœ“ Ingeschreven</span>' : ''}
              ${isVliegend ? '<span style="position:absolute;top:-2px;right:-2px;background:#10b981;color:white;border-radius:50%;width:16px;height:16px;font-size:0.7rem;display:flex;align-items:center;justify-content:center;">ðŸ•Šï¸</span>' : ''}
            </label>
          `;
        }).join('');

        // Maak deelnemers tabel met verbeterde error handling
        let deelnemersTabel = '';
        if (deelnemers && deelnemers.length > 0) {
          const gesorteerdeDeelnemers = deelnemers.filter(d => d.duiven).sort((a, b) => (b.gemiddelde_snelheid || 0) - (a.gemiddelde_snelheid || 0));
          console.log('ðŸ† Gesorteerde deelnemers:', gesorteerdeDeelnemers.length);
          
          if (gesorteerdeDeelnemers.length === 0) {
            deelnemersTabel = `
              <div class="race-table" style="margin-top:2rem;">
                <div class="race-header">
                  <h3 class="race-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Probleem met Deelnemers
                  </h3>
                </div>
                <div style='padding:1.5rem;text-align:center;color:#ef4444;background:#fef2f2;border-radius:8px;margin:1rem;'>
                  <p><strong>Geen deelnemers gevonden.</strong></p>
                  <p style="font-size:0.9rem;margin-top:0.5rem;">Mogelijke oorzaken:</p>
                  <ul style="text-align:left;display:inline-block;margin-top:0.5rem;">
                    <li>RLS policies blokkeren data toegang</li>
                    <li>Duiven zijn niet correct opgeslagen</li>
                    <li>Database connectie probleem</li>
                  </ul>
                  <p style="font-size:0.9rem;margin-top:1rem;">Check de browser console voor details.</p>
                </div>
              </div>`;
          } else {
            deelnemersTabel = `
              <div class="race-table" style="margin-top:2rem;animation:fadeIn 0.5s;">
                <div class="race-header">
                  <h3 class="race-title">
                    <i class="fas fa-trophy"></i>
                    Ingeschreven Duiven (${gesorteerdeDeelnemers.length})
                  </h3>
                </div>
                            <table style="background:#f8fafc;border-radius:8px;border-collapse:collapse;width:100%;font-size:0.85rem;">
              <thead>
                <tr style="background:#e2e8f0;border-bottom:2px solid #cbd5e1;">
                  <th class="position" style="width:40px;padding:0.5rem 0.25rem;text-align:center;font-size:0.8rem;">Pos</th>
                  <th style="width:140px;padding:0.5rem 0.25rem;text-align:left;font-size:0.8rem;">Duif</th>
                  <th style="width:100px;padding:0.5rem 0.25rem;text-align:center;font-size:0.8rem;">Team</th>
                  <th style="width:85px;padding:0.5rem 0.25rem;text-align:center;font-size:0.8rem;">Gem. Snelheid</th>
                  <th style="width:75px;padding:0.5rem 0.25rem;text-align:center;font-size:0.8rem;">Huidige</th>
                  <th style="width:60px;padding:0.5rem 0.25rem;text-align:center;font-size:0.8rem;">Afgelegd</th>
                  <th style="width:60px;padding:0.5rem 0.25rem;text-align:center;font-size:0.8rem;">Resterend</th>
                  <th style="width:100px;padding:0.5rem 0.25rem;text-align:center;font-size:0.8rem;">Voortgang</th>
                  <th style="width:60px;padding:0.5rem 0.25rem;text-align:center;font-size:0.8rem;">Tijd</th>
                </tr>
              </thead>
              <tbody>
                    ${gesorteerdeDeelnemers.map((deelnemer, index) => {
                      const percentage = ((deelnemer.huidige_afstand_gevlogen || 0) / vlucht.afstand_km) * 100;
                      const positie = index + 1;
                      const medalClass = positie <= 3 ? `medal ${positie === 1 ? 'gold' : positie === 2 ? 'silver' : 'bronze'}` : '';
                      const medalIcon = positie === 1 ? 'ðŸ¥‡' : positie === 2 ? 'ðŸ¥ˆ' : positie === 3 ? 'ðŸ¥‰' : '';
                                        return `
                    <tr style="border-bottom:1px solid #e2e8f0;transition:background-color 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                      <td class="position ${medalClass}" style="padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;font-weight:600;">${medalIcon || positie}</td>
                      <td style="padding:0.4rem 0.25rem;">
                        <div class="duif-naam-cell" style="gap:0.3rem;display:flex;align-items:center;">
                          <span class="duif-geslacht-cell ${deelnemer.duiven.geslacht}" style="font-size:0.9rem;">${deelnemer.duiven.geslacht === 'man' ? 'â™‚' : 'â™€'}</span>
                          <span class="duif-naam-link" style="font-weight:600;font-size:0.85rem;color:#1f2937;cursor:pointer;text-decoration:underline;" onclick="toonDuifProfiel('${deelnemer.duif_id}')">${deelnemer.duiven.naam}</span>
                        </div>
                      </td>
                      <td style="padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;color:#6b7280;font-weight:500;">
                        ${deelnemer.duiven.users?.team_naam || 'Onbekend Team'}
                      </td>
                      <td class="speed-cell" style="color:#059669;font-weight:600;padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;">${Math.round(deelnemer.gemiddelde_snelheid || 0)} km/u</td>
                      <td class="speed-cell" style="color:#3b82f6;font-weight:600;padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;">${Math.round(deelnemer.huidige_snelheid || deelnemer.gemiddelde_snelheid || 0)} km/u</td>
                      <td style="font-size:0.8rem;padding:0.4rem 0.25rem;text-align:center;">${(deelnemer.huidige_afstand_gevlogen || 0).toFixed(1)} km</td>
                      <td style="font-size:0.8rem;padding:0.4rem 0.25rem;text-align:center;">${(deelnemer.afstand_nog_te_gaan || vlucht.afstand_km).toFixed(1)} km</td>
                      <td style="padding:0.4rem 0.25rem;">
                        <div class="progress-container" style="height:4px;background:#e2e8f0;border-radius:2px;margin-bottom:0.2rem;">
                          <div class="progress-bar" style="width: ${percentage}%;background:linear-gradient(90deg,#10b981,#059669);border-radius:2px;height:100%;"></div>
                        </div>
                        <div class="progress-text" style="font-size:0.75rem;color:#64748b;text-align:center;">${percentage.toFixed(1)}%</div>
                      </td>
                      <td style="font-size:0.8rem;padding:0.4rem 0.25rem;text-align:center;color:#64748b;">${calculateTime(deelnemer)}</td>
                    </tr>
                  `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            `;
          }
        } else {
          deelnemersTabel = `
            <div class="race-table" style="margin-top:2rem;">
              <div class="race-header">
                <h3 class="race-title">
                  <i class="fas fa-users"></i>
                  Ingeschreven Duiven
                </h3>
              </div>
              <div style='padding:1.5rem;text-align:center;color:#6b7280;background:#f9fafb;border-radius:8px;margin:1rem;'>
                <i class="fas fa-info-circle" style="font-size:1.5rem;margin-bottom:0.5rem;display:block;"></i>
                <p>Nog geen duiven ingeschreven voor deze training.</p>
                <p style="font-size:0.9rem;margin-top:0.5rem;">Selecteer duiven hierboven en klik op "Opslaan".</p>
              </div>
            </div>`;
        }

        const detailHTML = `
          <div class="vlucht-detail">
            <div class="detail-controls">
              <button class="detail-btn minimize-btn" onclick="minimaliseerVluchtDetail()" title="Minimaliseren">
                <i class="fas fa-minus"></i>
              </button>
            </div>
            
            <div class="vlucht-header">
              <h2 class="vlucht-title">${vlucht.naam} (${vlucht.afstand_km} km)</h2>
              <p class="vlucht-route">${vlucht.start_locatie} â†’ ${vlucht.eind_locatie}</p>
              <div class="vlucht-status ${vlucht.status}">
                <i class="fas fa-${vlucht.status === 'actief' ? 'play' : vlucht.status === 'voltooid' ? 'check' : 'clock'}"></i>
                Status: ${vlucht.status.charAt(0).toUpperCase() + vlucht.status.slice(1)}
              </div>
            </div>
            
            ${user && user.email === 'wesley.wyngaerd@outlook.com' ? `
              <div class="control-buttons">
                <button class="control-btn start" onclick="startVlucht('${vlucht.id}')" ${vlucht.status === 'actief' || vlucht.status === 'voltooid' ? 'disabled' : ''}>
                  <i class="fas fa-play"></i>
                  Start Simulatie
                </button>
                <button class="control-btn pause" onclick="pauseVlucht('${vlucht.id}')" ${vlucht.status !== 'actief' ? 'disabled' : ''}>
                  <i class="fas fa-pause"></i>
                  Pauzeer
                </button>
                <button class="control-btn reset" onclick="resetVlucht('${vlucht.id}')">
                  <i class="fas fa-undo"></i>
                  Reset
                </button>
                <button class="control-btn fast-forward" onclick="fastForwardVlucht('${vlucht.id}')" ${vlucht.status !== 'actief' ? 'disabled' : ''}>
                  <i class="fas fa-forward"></i>
                  2x Snelheid
                </button>
              </div>
            ` : ''}
            
            <form id="duiven-inschrijf-form">
              <div class="form-section">
                <h3 class="form-title">
                  <i class="fas fa-users"></i>
                  Duiven in vliegkooien (${duiven.length} beschikbaar)
                </h3>
                <div style="margin-bottom: 1rem;">
                  <button type="button" class="select-all-btn" onclick="selectAllDuiven()" style="
                    background: var(--primary-color);
                    color: white;
                    border: none;
                    padding: 0.5rem 1rem;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 0.875rem;
                    margin-right: 0.5rem;
                  ">
                    <i class="fas fa-check-square"></i>
                    Selecteer Alle
                  </button>
                  <button type="button" class="deselect-all-btn" onclick="deselectAllDuiven()" style="
                    background: var(--text-secondary);
                    color: white;
                    border: none;
                    padding: 0.5rem 1rem;
                    border-radius: 6px;
                    cursor: pointer;
                    font-size: 0.875rem;
                  ">
                    <i class="fas fa-square"></i>
                    Deselecteer Alle
                  </button>
                </div>
                <div class="duiven-lijst">${lijst}</div>
                <button type="submit" class="submit-btn" id="opslaan-btn">
                  <i class="fas fa-save"></i>
                  Opslaan
                </button>
              </div>
            </form>
            
            ${deelnemersTabel}
          </div>
        `;

        document.getElementById('trainingContent').innerHTML = detailHTML;

        // Start interval voor actieve training (voor alle gebruikers om live te volgen)
        if (vlucht.status === 'actief') {
          // Alle gebruikers volgen de simulatie via database synchronisatie
          const syncInterval = setInterval(async () => {
            await syncSimulationData(vlucht.id);
          }, 5000); // 5 seconden om database te ontlasten
          
          // Stop interval wanneer pagina wordt verlaten
          window.addEventListener('beforeunload', () => {
            clearInterval(syncInterval);
          });
        }

        // Form handler met uitgebreide logging en error handling
        document.getElementById('duiven-inschrijf-form').onsubmit = async function(e) {
          e.preventDefault();
          
          console.log('ðŸ’¾ Start opslaan deelnemers...');
          
          const opslaanBtn = document.getElementById('opslaan-btn');
          const originalText = opslaanBtn.innerHTML;
          opslaanBtn.disabled = true;
          opslaanBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Opslaan...';
          
          try {
            const checkboxes = document.querySelectorAll('.duif-checkbox');
            const geselecteerd = Array.from(checkboxes).filter(cb => cb.checked).map(cb => cb.value);
            const vluchtId = String(vlucht.id).trim();
            
            console.log('ðŸ“‹ Geselecteerde duiven:', geselecteerd);
            console.log('ðŸ†” Vlucht ID:', vluchtId);
            
            // Extra beveiliging: controleer dat alleen eigen duiven worden ingeschreven
            const eigenDuifIds = duiven.filter(d => d.user_id === user.id).map(d => d.id);
            const onbevoegdeDuiven = geselecteerd.filter(duifId => !eigenDuifIds.includes(duifId));
            
            if (onbevoegdeDuiven.length > 0) {
              console.error('âŒ Onbevoegde duiven gedetecteerd:', onbevoegdeDuiven);
              throw new Error('Je kunt alleen je eigen duiven inschrijven voor trainingen.');
            }
            
            // Verwijder alleen eigen bestaande deelnemers
            console.log('ðŸ—‘ï¸ Verwijderen eigen bestaande deelnemers...');
            
            // Haal eerst eigen bestaande deelnemers op
            const { data: eigenDeelnemers, error: eigenDeelnemersError } = await supabase
              .from('trainingsvlucht_deelnames')
              .select('duif_id')
              .eq('trainingsvlucht_id', vluchtId)
              .in('duif_id', eigenDuifIds);
              
            if (eigenDeelnemersError) {
              console.error('âŒ Fout bij ophalen eigen deelnemers:', eigenDeelnemersError);
              throw new Error('Fout bij ophalen eigen deelnemers: ' + eigenDeelnemersError.message);
            }
            
            const eigenDuifIdsInTraining = (eigenDeelnemers || []).map(d => d.duif_id);

            // Bepaal welke duiven toegevoegd of verwijderd moeten worden
            const toeTeVoegen = geselecteerd.filter(duifId => !eigenDuifIdsInTraining.includes(duifId));
            const teVerwijderen = eigenDuifIdsInTraining.filter(duifId => !geselecteerd.includes(duifId));

            // Voeg nieuwe eigen deelnemers toe
            if (toeTeVoegen.length > 0) {
              console.log('âž• Toevoegen nieuwe eigen deelnemers...');
              const rows = toeTeVoegen.map(duifId => ({
                trainingsvlucht_id: vluchtId,
                duif_id: duifId,
                status: 'ingeschreven'
              }));
              console.log('ðŸ“ Rijen om toe te voegen:', rows);
              const { data: insertData, error: insertError } = await supabase
                .from('trainingsvlucht_deelnames')
                .insert(rows, { returning: 'minimal' });
              if (insertError) {
                console.error('âŒ Fout bij toevoegen nieuwe deelnemers:', insertError);
                throw new Error('Fout bij toevoegen nieuwe deelnemers: ' + insertError.message);
              }
              console.log('âœ… Nieuwe eigen deelnemers toegevoegd:', insertData);
            }

            // Verwijder uitgeschreven eigen deelnemers
            if (teVerwijderen.length > 0) {
              console.log('ðŸ—‘ï¸ Verwijderen uitgeschreven eigen deelnemers...');
              const { error: deleteError } = await supabase
                .from('trainingsvlucht_deelnames')
                .delete()
                .eq('trainingsvlucht_id', vluchtId)
                .in('duif_id', teVerwijderen);
              if (deleteError) {
                console.error('âŒ Fout bij verwijderen eigen deelnemers:', deleteError);
                throw new Error('Fout bij verwijderen eigen deelnemers: ' + deleteError.message);
              }
              console.log('âœ… Uitgeschreven eigen deelnemers verwijderd');
            }
            
            console.log('ðŸ”„ Herladen vlucht detail...');
            
            // Herlaad vlucht detail
            const { data: vluchtNieuw, error: reloadError } = await supabase
              .from('trainingsvluchten')
              .select('*')
              .eq('id', vluchtId)
              .single();
              
            if (reloadError) {
              console.error('âŒ Fout bij herladen vlucht:', reloadError);
              throw new Error('Fout bij herladen vlucht: ' + reloadError.message);
            }
            
            if (vluchtNieuw) {
              await laadVluchtDetail(vluchtNieuw);
              showNotification(`âœ… ${geselecteerd.length} duiven succesvol opgeslagen voor training!`, 'success');
              console.log('ðŸŽ‰ Opslaan voltooid!');
            }
          } catch (error) {
            console.error('âŒ Error saving participants:', error);
            showNotification('âŒ Fout bij opslaan deelnemers: ' + error.message, 'error');
          } finally {
            opslaanBtn.disabled = false;
            opslaanBtn.innerHTML = originalText;
          }
        };
      } catch (error) {
        console.error('âŒ Error loading flight detail:', error);
        showNotification('Fout bij laden vlucht details: ' + error.message, 'error');
      }
    }

    function calculateTime(deelnemer) {
      if (!simulationStartTime) return '00:00';
      
      const nu = new Date();
      const verstrekenMs = nu - simulationStartTime;
      const verstrekenMinuten = Math.floor(verstrekenMs / (1000 * 60));
      const verstrekenSeconden = Math.floor((verstrekenMs % (1000 * 60)) / 1000);
      
      return `${verstrekenMinuten.toString().padStart(2, '0')}:${verstrekenSeconden.toString().padStart(2, '0')}`;
    }

    // Fast forward function
    window.fastForwardVlucht = function(vluchtId) {
      fastForwardMode = (fastForwardMode + 1) % 4; // 0, 1, 2, 3
      const btn = document.querySelector(`button[onclick="fastForwardVlucht('${vluchtId}')"]`);
      if (btn) {
        if (fastForwardMode === 0) {
          btn.innerHTML = '<i class="fas fa-forward"></i> 2x Snelheid';
          btn.style.background = 'linear-gradient(135deg, #8b5cf6, #7c3aed)';
        } else if (fastForwardMode === 1) {
          btn.innerHTML = '<i class="fas fa-forward"></i> 5x Snelheid';
          btn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
        } else if (fastForwardMode === 2) {
          btn.innerHTML = '<i class="fas fa-forward"></i> 10x Snelheid';
          btn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
        } else {
          btn.innerHTML = '<i class="fas fa-pause"></i> Normale Snelheid';
          btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
        }
      }
      
      // Restart interval with new speed
      if (trainingInterval) {
        startTrainingInterval(vluchtId);
      }
    };

    // Control functions
    window.startVlucht = async function(vluchtId) {
      try {
        const startBtn = document.querySelector(`button[onclick="startVlucht('${vluchtId}')"]`);
        if (startBtn) {
          startBtn.disabled = true;
          startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Starten...';
        }
        
        // Update vlucht status
        const { error } = await supabase
          .from('trainingsvluchten')
          .update({ 
            status: 'actief',
            start_tijd: new Date().toISOString()
          })
          .eq('id', vluchtId);

        if (error) throw error;

        // Start simulatie
        startTrainingInterval(vluchtId);
        
        // Herlaad vlucht detail
        const { data: vluchtNieuw } = await supabase.from('trainingsvluchten').select('*').eq('id', vluchtId).single();
        if (vluchtNieuw) {
          await laadVluchtDetail(vluchtNieuw);
          showNotification('Simulatie gestart!', 'success');
        }
      } catch (error) {
        console.error('Error starting flight:', error);
        showNotification('Fout bij starten simulatie', 'error');
        
        // Reset button state
        const startBtn = document.querySelector(`button[onclick="startVlucht('${vluchtId}')"]`);
        if (startBtn) {
          startBtn.disabled = false;
          startBtn.innerHTML = '<i class="fas fa-play"></i> Start Simulatie';
        }
      }
    };

    window.pauseVlucht = async function(vluchtId) {
      try {
        const pauseBtn = document.querySelector(`button[onclick="pauseVlucht('${vluchtId}')"]`);
        if (pauseBtn) {
          pauseBtn.disabled = true;
          pauseBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Pauzeren...';
        }
        
        // Stop simulatie
        if (trainingInterval) {
          clearInterval(trainingInterval);
          trainingInterval = null;
        }
        
        // Update vlucht status
        const { error } = await supabase
          .from('trainingsvluchten')
          .update({ status: 'gepland' })
          .eq('id', vluchtId);

        if (error) throw error;

        // Herlaad vlucht detail
        const { data: vluchtNieuw } = await supabase.from('trainingsvluchten').select('*').eq('id', vluchtId).single();
        if (vluchtNieuw) {
          await laadVluchtDetail(vluchtNieuw);
          showNotification('Simulatie gepauzeerd', 'info');
        }
      } catch (error) {
        console.error('Error pausing flight:', error);
        showNotification('Fout bij pauzeren simulatie', 'error');
      }
    };

    window.resetVlucht = async function(vluchtId) {
      try {
        const resetBtn = document.querySelector(`button[onclick="resetVlucht('${vluchtId}')"]`);
        if (resetBtn) {
          resetBtn.disabled = true;
          resetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resetten...';
        }
        
        // Stop simulatie
        if (trainingInterval) {
          clearInterval(trainingInterval);
          trainingInterval = null;
        }
        
        // Verwijder simulatie data uit localStorage
        clearSimulationFromStorage(vluchtId);
        
        // Verwijder alle deelnemers
        await supabase.from('trainingsvlucht_deelnames').delete().eq('trainingsvlucht_id', vluchtId);
        
        // Reset vlucht status
        const { error } = await supabase
          .from('trainingsvluchten')
          .update({ 
            status: 'gepland',
            start_tijd: null,
            eind_tijd: null,
            winnaar_id: null
          })
          .eq('id', vluchtId);

        if (error) throw error;

        // Herlaad vlucht detail
        const { data: vluchtNieuw } = await supabase.from('trainingsvluchten').select('*').eq('id', vluchtId).single();
        if (vluchtNieuw) {
          await laadVluchtDetail(vluchtNieuw);
          showNotification('Simulatie gereset', 'info');
        }
      } catch (error) {
        console.error('Error resetting flight:', error);
        showNotification('Fout bij resetten simulatie', 'error');
      }
    };

    // Offline simulatie - Supabase alleen voor opslag, niet voor real-time updates
    let offlineSimulationData = null;
    let simulationStartTime = null;
    let simulationTimeout = null;
    let maxSimulationTime = 30 * 60 * 1000; // 30 minuten maximum
    
    // Functie om simulatie data op te slaan in localStorage
    function saveSimulationToStorage(vluchtId, data) {
      try {
        localStorage.setItem(`simulation_${vluchtId}`, JSON.stringify({
          data: data,
          startTime: simulationStartTime,
          lastUpdate: new Date().toISOString()
        }));
      } catch (error) {
        console.error('âŒ Fout bij opslaan simulatie data:', error);
      }
    }
    
    // Functie om simulatie data te laden uit localStorage
    function loadSimulationFromStorage(vluchtId) {
      try {
        const stored = localStorage.getItem(`simulation_${vluchtId}`);
        if (stored) {
          const parsed = JSON.parse(stored);
          offlineSimulationData = parsed.data;
          simulationStartTime = new Date(parsed.startTime);
          return true;
        }
      } catch (error) {
        console.error('âŒ Fout bij laden simulatie data:', error);
      }
      return false;
    }
    
    // Functie om simulatie data te verwijderen uit localStorage
    function clearSimulationFromStorage(vluchtId) {
      try {
        localStorage.removeItem(`simulation_${vluchtId}`);
      } catch (error) {
        console.error('âŒ Fout bij verwijderen simulatie data:', error);
      }
    }
    
    function startTrainingInterval(vluchtId) {
      if (trainingInterval) {
        clearInterval(trainingInterval);
      }
      
      // Controleer of er al een lopende simulatie is
      if (loadSimulationFromStorage(vluchtId)) {
        console.log('ðŸ”„ Herstel lopende simulatie voor vlucht:', vluchtId);
        
        // Bereken hoeveel tijd er is verstreken sinds laatste update
        const nu = new Date();
        const lastUpdate = new Date(offlineSimulationData.lastUpdate || simulationStartTime);
        const tijdVerstreken = (nu - lastUpdate) / 1000; // seconden
        
        // Update simulatie data met verstreken tijd
        if (tijdVerstreken > 0) {
          console.log(`â° ${tijdVerstreken.toFixed(1)} seconden verstreken, simulatie herstellen...`);
          updateOfflineSimulationWithTime(vluchtId, tijdVerstreken);
        }
        
        // Start interval opnieuw
        const interval = fastForwardMode === 0 ? 2000 : fastForwardMode === 1 ? 1500 : fastForwardMode === 2 ? 1000 : 800;
        trainingInterval = setInterval(() => {
          updateOfflineSimulation(vluchtId);
        }, interval);
        
        // Update UI direct
        updateOfflineDeelnemersTabel();
        return;
      }
      
      // Start nieuwe offline simulatie
      console.log('ðŸš€ Start nieuwe simulatie voor vlucht:', vluchtId);
      simulationStartTime = new Date();
      offlineSimulationData = {
        vluchtId: vluchtId,
        deelnemers: [],
        status: 'actief',
        lastUpdate: new Date().toISOString()
      };
      
      // Laad initiÃ«le data Ã©Ã©n keer
      loadInitialSimulationData(vluchtId).then(() => {
        const interval = fastForwardMode === 0 ? 2000 : fastForwardMode === 1 ? 1500 : fastForwardMode === 2 ? 1000 : 800;
        
        trainingInterval = setInterval(() => {
          updateOfflineSimulation(vluchtId);
        }, interval);
      });
    }
    
    // Laad initiÃ«le data Ã©Ã©n keer
    async function loadInitialSimulationData(vluchtId) {
      try {
        // Haal vlucht informatie op
        const { data: vlucht, error: vluchtError } = await supabase
          .from('trainingsvluchten')
          .select('*')
          .eq('id', vluchtId)
          .single();
          
        if (vluchtError) throw vluchtError;
        
        // Haal deelnemers op
        const { data: deelnemers, error } = await supabase
          .from('trainingsvlucht_deelnames')
          .select('*, duiven!fk_duif(*, users!duiven_user_id_fkey(team_naam))')
          .eq('trainingsvlucht_id', vluchtId);
          
        if (error) throw error;
        
        // Sla vlucht afstand op in offline data
        offlineSimulationData.vluchtAfstand = vlucht.afstand_km || 22;
        
        offlineSimulationData.deelnemers = deelnemers.map(d => ({
          ...d,
          huidige_afstand_gevlogen: 0,
          afstand_nog_te_gaan: offlineSimulationData.vluchtAfstand,
          gemiddelde_snelheid: 0,
          status: 'ingeschreven'
        }));
        
        console.log('ðŸ“Š Offline simulatie gestart met', offlineSimulationData.deelnemers.length, 'deelnemers voor', offlineSimulationData.vluchtAfstand, 'km');
      } catch (error) {
        console.error('âŒ Fout bij laden simulatie data:', error);
      }
    }
    
    // Update simulatie met verstreken tijd (voor herstel)
    function updateOfflineSimulationWithTime(vluchtId, verstrekenSeconden) {
      if (!offlineSimulationData || !simulationStartTime) return;
      
      const tijdVerstreken = verstrekenSeconden / (60 * 60); // uren
      let alleVoltooid = true;
      let winnaar = null;
      let besteTijd = Infinity;
      
      offlineSimulationData.deelnemers.forEach(deelnemer => {
        if (deelnemer.status === 'voltooid') return;
        
        const duif = deelnemer.duiven;
        if (!duif) return;
        
        // Bereken basis snelheid
        let basisSnelheid = 60;
        basisSnelheid += (parseFloat(duif.snelheid) || 0) * 0.6;
        basisSnelheid += (parseFloat(duif.conditie) || 0) * 0.3;
        basisSnelheid += (parseFloat(duif.oriÃ«ntatie) || 0) * 0.1;
        basisSnelheid += (parseFloat(duif.techniek) || 0) * 0.1;
        basisSnelheid += (parseFloat(duif.ervaring) || 0) * 0.05;
        
        // Voeg variatie toe
        const variatie = (Math.random() - 0.5) * 0.2;
        const snelheidMetVariatie = basisSnelheid * (1 + variatie);
        
        // Bereken afstand met verstreken tijd
        const vluchtAfstand = offlineSimulationData.vluchtAfstand || 22;
        const afstandPerSeconde = snelheidMetVariatie / 3600;
        const huidigeAfstand = parseFloat(deelnemer.huidige_afstand_gevlogen) || 0;
        const extraAfstand = afstandPerSeconde * verstrekenSeconden;
        const nieuweAfstand = Math.min(vluchtAfstand, huidigeAfstand + extraAfstand);
        
        // Update deelnemer data
        deelnemer.huidige_afstand_gevlogen = nieuweAfstand;
        deelnemer.afstand_nog_te_gaan = vluchtAfstand - nieuweAfstand;
        deelnemer.gemiddelde_snelheid = tijdVerstreken > 0 ? nieuweAfstand / tijdVerstreken : 0;
        deelnemer.huidige_snelheid = snelheidMetVariatie;
        
        // Check of voltooid
        if (nieuweAfstand >= 45) {
          deelnemer.status = 'voltooid';
          const totaleTijd = tijdVerstreken * 60;
          if (totaleTijd < besteTijd) {
            besteTijd = totaleTijd;
            winnaar = deelnemer.duif_id;
          }
        } else {
          alleVoltooid = false;
        }
      });
      
      // Update lastUpdate tijd
      offlineSimulationData.lastUpdate = new Date().toISOString();
      saveSimulationToStorage(vluchtId, offlineSimulationData);
      
      // Check of simulatie klaar is
      if (alleVoltooid) {
        finishOfflineSimulation(vluchtId, winnaar);
      }
    }
    
    // Offline simulatie update (geen database calls)
    function updateOfflineSimulation(vluchtId) {
      if (!offlineSimulationData || !simulationStartTime) {
        console.warn('âš ï¸ Geen simulatie data beschikbaar, stop simulatie');
        if (trainingInterval) {
          clearInterval(trainingInterval);
          trainingInterval = null;
        }
        return;
      }
      
      // Veiligheidscheck - stop simulatie als er geen deelnemers zijn
      if (!offlineSimulationData.deelnemers || offlineSimulationData.deelnemers.length === 0) {
        console.warn('âš ï¸ Geen deelnemers in simulatie, stop simulatie');
        if (trainingInterval) {
          clearInterval(trainingInterval);
          trainingInterval = null;
        }
        return;
      }
      
      const nu = new Date();
      const tijdVerstreken = (nu - simulationStartTime) / (1000 * 60 * 60); // uren
      
      // Veiligheidscheck - stop simulatie als deze te lang duurt
      const elapsedMs = nu - simulationStartTime;
      if (elapsedMs > maxSimulationTime) {
        console.warn('âš ï¸ Simulatie duurt te lang, forceer einde');
        finishOfflineSimulation(vluchtId, null);
        return;
      }
      
      let alleVoltooid = true;
      let winnaar = null;
      let besteTijd = Infinity;
      
      offlineSimulationData.deelnemers.forEach(deelnemer => {
        if (deelnemer.status === 'voltooid') return;
        
        const duif = deelnemer.duiven;
        if (!duif) return;
        
        // Bereken basis snelheid (zelfde logica als voorheen)
        let basisSnelheid = 60;
        basisSnelheid += (parseFloat(duif.snelheid) || 0) * 0.6;
        basisSnelheid += (parseFloat(duif.conditie) || 0) * 0.3;
        basisSnelheid += (parseFloat(duif.oriÃ«ntatie) || 0) * 0.1;
        basisSnelheid += (parseFloat(duif.techniek) || 0) * 0.1;
        basisSnelheid += (parseFloat(duif.ervaring) || 0) * 0.05;
        
        // Voeg variatie toe
        const variatie = (Math.random() - 0.5) * 0.2;
        const snelheidMetVariatie = basisSnelheid * (1 + variatie);
        
        // Bereken afstand per interval - aangepast voor correcte snelheid
        const intervalInSeconden = fastForwardMode === 0 ? 2 : fastForwardMode === 1 ? 1.5 : fastForwardMode === 2 ? 1 : 0.8;
        const afstandPerInterval = (snelheidMetVariatie / 3600) * intervalInSeconden;
        const huidigeAfstand = parseFloat(deelnemer.huidige_afstand_gevlogen) || 0;
        
        // Veiligheidscheck - voorkom negatieve of oneindige waarden
        if (isNaN(afstandPerInterval) || afstandPerInterval < 0 || !isFinite(afstandPerInterval)) {
          console.warn('âš ï¸ Ongeldige afstand berekening voor duif:', deelnemer.duif_id);
          return; // Stop deze update cyclus
        }
        
        // Haal vlucht afstand op uit de data
        const vluchtAfstand = offlineSimulationData.vluchtAfstand || 22; // Default 22km als fallback
        const nieuweAfstand = Math.min(vluchtAfstand, huidigeAfstand + afstandPerInterval);
        
        // Update deelnemer data
        deelnemer.huidige_afstand_gevlogen = nieuweAfstand;
        deelnemer.afstand_nog_te_gaan = vluchtAfstand - nieuweAfstand;
        deelnemer.gemiddelde_snelheid = tijdVerstreken > 0 ? nieuweAfstand / tijdVerstreken : 0;
        deelnemer.huidige_snelheid = snelheidMetVariatie; // Huidige momentane snelheid
        
        // Check of voltooid
        if (nieuweAfstand >= 45) {
          deelnemer.status = 'voltooid';
          const totaleTijd = tijdVerstreken * 60;
          if (totaleTijd < besteTijd) {
            besteTijd = totaleTijd;
            winnaar = deelnemer.duif_id;
          }
        } else {
          alleVoltooid = false;
        }
      });
      
      // Update lastUpdate tijd en sla op
      offlineSimulationData.lastUpdate = new Date().toISOString();
      saveSimulationToStorage(vluchtId, offlineSimulationData);
      
      // Update UI
      updateOfflineDeelnemersTabel();
      
      // Check of simulatie klaar is
      if (alleVoltooid) {
        finishOfflineSimulation(vluchtId, winnaar);
      }
    }
    
    // Update UI zonder database calls
    function updateOfflineDeelnemersTabel() {
      if (!offlineSimulationData) return;
      
      const gesorteerdeDeelnemers = [...offlineSimulationData.deelnemers]
        .sort((a, b) => (b.gemiddelde_snelheid || 0) - (a.gemiddelde_snelheid || 0));
      
      const raceTable = document.querySelector('.race-table');
      if (raceTable && gesorteerdeDeelnemers.length > 0) {
        const tbody = raceTable.querySelector('tbody');
        if (tbody) {
                      tbody.innerHTML = gesorteerdeDeelnemers.map((deelnemer, index) => {
              const vluchtAfstand = offlineSimulationData.vluchtAfstand || 22;
              const percentage = Math.min(100, ((deelnemer.huidige_afstand_gevlogen || 0) / vluchtAfstand) * 100);
              const positie = index + 1;
              const medalClass = positie <= 3 ? `medal ${positie === 1 ? 'gold' : positie === 2 ? 'silver' : 'bronze'}` : '';
              const medalIcon = positie === 1 ? 'ðŸ¥‡' : positie === 2 ? 'ðŸ¥ˆ' : positie === 3 ? 'ðŸ¥‰' : '';
              return `
                <tr style="border-bottom:1px solid #e2e8f0;transition:background-color 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                  <td class="position ${medalClass}" style="padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;font-weight:600;">${medalIcon || positie}</td>
                  <td style="padding:0.4rem 0.25rem;">
                    <div class="duif-naam-cell" style="gap:0.3rem;display:flex;align-items:center;">
                      <span class="duif-geslacht-cell ${deelnemer.duiven.geslacht}" style="font-size:0.9rem;">${deelnemer.duiven.geslacht === 'man' ? 'â™‚' : 'â™€'}</span>
                      <span class="duif-naam-link" style="font-weight:600;font-size:0.85rem;color:#1f2937;cursor:pointer;text-decoration:underline;" onclick="toonDuifProfiel('${deelnemer.duif_id}')">${deelnemer.duiven.naam}</span>
                    </div>
                  </td>
                  <td style="padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;color:#6b7280;font-weight:500;">
                    ${deelnemer.duiven.users?.team_naam || 'Onbekend Team'}
                  </td>
                  <td class="speed-cell" style="color:#059669;font-weight:600;padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;">${Math.round(deelnemer.gemiddelde_snelheid || 0)} km/u</td>
                  <td class="speed-cell" style="color:#3b82f6;font-weight:600;padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;">${Math.round(deelnemer.huidige_snelheid || deelnemer.gemiddelde_snelheid || 0)} km/u</td>
                  <td style="font-size:0.8rem;padding:0.4rem 0.25rem;text-align:center;">${(deelnemer.huidige_afstand_gevlogen || 0).toFixed(1)} km</td>
                  <td style="font-size:0.8rem;padding:0.4rem 0.25rem;text-align:center;">${(deelnemer.afstand_nog_te_gaan || vluchtAfstand).toFixed(1)} km</td>
                  <td style="padding:0.4rem 0.25rem;">
                    <div class="progress-container" style="height:4px;background:#e2e8f0;border-radius:2px;margin-bottom:0.2rem;">
                      <div class="progress-bar" style="width: ${percentage}%;background:linear-gradient(90deg,#10b981,#059669);border-radius:2px;height:100%;"></div>
                    </div>
                    <div class="progress-text" style="font-size:0.75rem;color:#64748b;text-align:center;">${percentage.toFixed(1)}%</div>
                  </td>
                  <td style="font-size:0.8rem;padding:0.4rem 0.25rem;text-align:center;color:#64748b;">${calculateTime(deelnemer)}</td>
                </tr>
              `;
            }).join('');
        }
      }
    }
    
        // Eindig simulatie en sla resultaten op
    async function finishOfflineSimulation(vluchtId, winnaar) {
      try {
        console.log('ðŸ BeÃ«indig simulatie voor vlucht:', vluchtId);
        
        if (trainingInterval) {
          clearInterval(trainingInterval);
          trainingInterval = null;
        }
        
        // Clear timeout als die bestaat
        if (simulationTimeout) {
          clearTimeout(simulationTimeout);
          simulationTimeout = null;
        }
        
        // Verwijder simulatie data uit localStorage
        clearSimulationFromStorage(vluchtId);
        
        // Update vlucht status naar voltooid
        const { error } = await supabase
          .from('trainingsvluchten')
          .update({ 
            status: 'voltooid',
            eind_tijd: new Date().toISOString(),
            winnaar_id: winnaar
          })
          .eq('id', vluchtId);

        if (error) throw error;

        // Batch update alle deelnemers
        if (offlineSimulationData && offlineSimulationData.deelnemers) {
          const updates = offlineSimulationData.deelnemers.map(d => ({
            id: d.id,
            huidige_afstand_gevlogen: d.huidige_afstand_gevlogen || 0,
            afstand_nog_te_gaan: d.afstand_nog_te_gaan || 0,
            gemiddelde_snelheid: d.gemiddelde_snelheid || 0,
            huidige_snelheid: d.huidige_snelheid || 0,
            status: d.status || 'voltooid'
          }));

          const { error: updateError } = await supabase
            .from('trainingsvlucht_deelnames')
            .upsert(updates);

          if (updateError) throw updateError;
        }

        showNotification('Simulatie voltooid!', 'success');
        console.log('ðŸŽ‰ Offline simulatie voltooid en opgeslagen');
        
        // Herlaad vlucht detail
        const { data: vluchtNieuw } = await supabase.from('trainingsvluchten').select('*').eq('id', vluchtId).single();
        if (vluchtNieuw) {
          await laadVluchtDetail(vluchtNieuw);
        }
        
      } catch (error) {
        console.error('âŒ Fout bij opslaan simulatie resultaten:', error);
        showNotification('Fout bij opslaan resultaten', 'error');
      }
    }

    // Nieuwe functie om alleen deelnemers tabel te updaten (minder belastend)
    async function updateDeelnemersTabel(vluchtId) {
      try {
        const { data: deelnemers, error } = await supabase
          .from('trainingsvlucht_deelnames')
          .select('*, duiven!fk_duif(*, users!duiven_user_id_fkey(team_naam))')
          .eq('trainingsvlucht_id', vluchtId);

        if (error) {
          console.error('âŒ Fout bij ophalen deelnemers voor update:', error);
          return;
        }

        if (!deelnemers || deelnemers.length === 0) return;

        const gesorteerdeDeelnemers = deelnemers.filter(d => d.duiven).sort((a, b) => (b.gemiddelde_snelheid || 0) - (a.gemiddelde_snelheid || 0));
        
        // Update alleen de tabel zonder hele pagina te herladen
        const raceTable = document.querySelector('.race-table');
        if (raceTable && gesorteerdeDeelnemers.length > 0) {
          const tbody = raceTable.querySelector('tbody');
          if (tbody) {
            tbody.innerHTML = gesorteerdeDeelnemers.map((deelnemer, index) => {
              const percentage = Math.min(100, ((deelnemer.huidige_afstand_gevlogen || 0) / vlucht.afstand_km) * 100);
              const positie = index + 1;
              const medalClass = positie <= 3 ? `medal ${positie === 1 ? 'gold' : positie === 2 ? 'silver' : 'bronze'}` : '';
              const medalIcon = positie === 1 ? 'ðŸ¥‡' : positie === 2 ? 'ðŸ¥ˆ' : positie === 3 ? 'ðŸ¥‰' : '';
              return `
                <tr>
                  <td class="position ${medalClass}">${medalIcon || positie}</td>
                  <td>
                    <div style="display:flex;align-items:center;gap:0.3rem;">
                      <span class="duif-geslacht-cell ${deelnemer.duiven.geslacht}" style="font-size:0.9rem;">${deelnemer.duiven.geslacht === 'man' ? 'â™‚' : 'â™€'}</span>
                      <span class="duif-naam-link" style="font-weight:700;font-size:1.1rem;color:#1f2937;cursor:pointer;text-decoration:underline;" onclick="toonDuifProfiel('${deelnemer.duif_id}')">${deelnemer.duiven.naam}</span>
                    </div>
                  </td>
                  <td style="text-align:center;color:#6b7280;font-weight:500;">${deelnemer.duiven.users?.team_naam || 'Onbekend Team'}</td>
                  <td class="speed-cell">${Math.round(deelnemer.gemiddelde_snelheid || 0)} km/u</td>
                  <td>${(deelnemer.huidige_afstand_gevlogen || 0).toFixed(1)} km</td>
                  <td>${(deelnemer.afstand_nog_te_gaan || 45).toFixed(1)} km</td>
                  <td>
                    <div class="progress-container">
                      <div class="progress-bar" style="width: ${percentage}%"></div>
                    </div>
                    <div class="progress-text">${percentage.toFixed(1)}%</div>
                  </td>
                  <td>${calculateTime(deelnemer)}</td>
                </tr>
              `;
            }).join('');
          }
        }
      } catch (error) {
        console.error('âŒ Fout bij updaten deelnemers tabel:', error);
      }
    }



    // Notification system
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation' : 'info'}"></i>
        <span>${message}</span>
      `;
      
      document.body.appendChild(notification);
      
      // Animate in
      setTimeout(() => notification.classList.add('show'), 100);
      
      // Remove after 3 seconds
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

    // Minimize function
    window.minimaliseerVluchtDetail = function() {
      loadTrainingData();
    };

    // Load training data
    loadTrainingData();
    
    // Update back link
    const backLink = document.getElementById('back-link');
    if (backLink) {
      backLink.href = 'index.html';
    }

    // Duif Profiel Popup - Volledig vernieuwd met moderne styling
    if (!document.getElementById('duifProfielPopup')) {
      const popup = document.createElement('div');
      popup.id = 'duifProfielPopup';
      popup.style = 'display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
      document.body.appendChild(popup);
    }
    
    window.toonDuifProfiel = async function(duifId) {
      let popup = document.getElementById('duifProfielPopup');
      if (!popup) {
        popup = document.createElement('div');
        popup.id = 'duifProfielPopup';
        popup.style = 'display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center;backdrop-filter:blur(4px);';
        document.body.appendChild(popup);
      }
      
      let profielDiv = document.getElementById('duifProfielContent');
      if (!profielDiv) {
        profielDiv = document.createElement('div');
        profielDiv.id = 'duifProfielContent';
        profielDiv.style = 'background:white;border-radius:24px;max-width:480px;min-width:360px;box-shadow:0 20px 60px rgba(0,0,0,0.3);position:relative;animation:fadeIn 0.4s;overflow:hidden;';
        popup.appendChild(profielDiv);
      }
      
      popup.style.display = 'flex';
      profielDiv.innerHTML = `
        <div style="text-align:center;padding:3rem 2rem;">
          <div class="fas fa-spinner fa-spin" style="font-size:2rem;color:#6b7280;margin-bottom:1rem;"></div>
          <p style="color:#6b7280;font-size:1.1rem;">Profiel laden...</p>
        </div>
      `;
      
      try {
        const { data: duif, error: duifError } = await supabase.from('duiven').select('*').eq('id', duifId).single();
        if (duifError || !duif) {
          profielDiv.innerHTML = `
            <div style="text-align:center;padding:3rem 2rem;color:#ef4444;">
              <i class="fas fa-exclamation-triangle" style="font-size:2rem;margin-bottom:1rem;"></i>
              <p>Duif niet gevonden.</p>
            </div>
          `;
          return;
        }
        
        // Haal prestaties op
        const { data: trainingen } = await supabase.from('trainingsvlucht_deelnames').select('*, trainingsvluchten(naam, afstand_km, datum)').eq('duif_id', duifId);
        const { data: wedstrijden } = await supabase.from('wedstrijd_deelnames').select('*, wedstrijden(naam, datum)').eq('duif_id', duifId);
        const { data: prijzen } = await supabase.from('medailles').select('*').eq('duif_id', duifId);
        
        // Bepaal kleuren
        const isVrouw = duif.geslacht === 'vrouw';
        const bgColor = isVrouw ? '#fdf2f8' : '#eff6ff';
        const borderColor = isVrouw ? '#ec4899' : '#3b82f6';
        const accentColor = isVrouw ? '#be185d' : '#1d4ed8';
        
        // Bereken leeftijd
        const leeftijdJaren = Math.floor(duif.leeftijd_maanden / 12);
        const leeftijdMaanden = duif.leeftijd_maanden % 12;
        
        // Moderne profiel layout
        profielDiv.innerHTML = `
          <div style="background:white;border-radius:24px;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
            <!-- Close button -->
            <button onclick="document.getElementById('duifProfielPopup').style.display='none'" 
                    style="position:absolute;top:1rem;right:1rem;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,0.1);border:none;cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:#6b7280;transition:all 0.2s;" 
                    onmouseover="this.style.background='rgba(0,0,0,0.2)'" 
                    onmouseout="this.style.background='rgba(0,0,0,0.1)'">
              Ã—
            </button>
            
            <!-- Header met achtergrond -->
            <div style="background:${bgColor};padding:1.5rem 2rem 1rem 2rem;text-align:center;position:relative;">
              <h2 style="margin:0 0 0.5rem 0;font-size:1.8rem;font-weight:700;color:#1f2937;">${duif.naam}</h2>
              <div style="display:flex;justify-content:center;gap:0.5rem;flex-wrap:wrap;">
                <div style="display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:white;border-radius:20px;border:2px solid ${borderColor};color:${accentColor};font-weight:600;font-size:0.9rem;">
                  <span style="font-size:1rem;">${isVrouw ? 'â™€' : 'â™‚'}</span>
                  ${isVrouw ? 'Vrouw' : 'Man'}
                </div>
                <div style="display:inline-flex;align-items:center;gap:0.5rem;padding:0.5rem 1rem;background:white;border-radius:20px;border:2px solid ${borderColor};color:${accentColor};font-weight:600;font-size:0.9rem;">
                  <span style="font-size:1rem;">ðŸ“…</span>
                  ${leeftijdJaren > 0 ? `${leeftijdJaren} Jaar en ${leeftijdMaanden} Maanden` : `${leeftijdMaanden} Maanden`}
                </div>
              </div>
            </div>
            
            <!-- Tab navigation -->
            <div style="background:white;border-bottom:1px solid #e5e7eb;">
              <div style="display:flex;gap:0;">
                <button class="profiel-tab-btn active" id="tab-eigenschappen" 
                        style="flex:1;padding:1rem;border:none;background:white;color:#6b7280;font-weight:600;cursor:pointer;transition:all 0.2s;border-bottom:3px solid transparent;">
                  <i class="fas fa-chart-bar" style="margin-right:0.5rem;"></i>Eigenschappen
                </button>
                <button class="profiel-tab-btn" id="tab-trainingen" 
                        style="flex:1;padding:1rem;border:none;background:white;color:#6b7280;font-weight:600;cursor:pointer;transition:all 0.2s;border-bottom:3px solid transparent;">
                  ðŸ•Šï¸ Trainingen
                </button>
                <button class="profiel-tab-btn" id="tab-wedstrijden" 
                        style="flex:1;padding:1rem;border:none;background:white;color:#6b7280;font-weight:600;cursor:pointer;transition:all 0.2s;border-bottom:3px solid transparent;">
                  <i class="fas fa-trophy" style="margin-right:0.5rem;"></i>Wedstrijden
                </button>
                <button class="profiel-tab-btn" id="tab-prijzen" 
                        style="flex:1;padding:1rem;border:none;background:white;color:#6b7280;font-weight:600;cursor:pointer;transition:all 0.2s;border-bottom:3px solid transparent;">
                  <i class="fas fa-medal" style="margin-right:0.5rem;"></i>Prijzenkast
                </button>
              </div>
            </div>
            
            <!-- Tab content -->
            <div id="profielTabContent" style="padding:2rem;max-height:400px;overflow-y:auto;"></div>
          </div>
          
          <style>
            .profiel-tab-btn.active { 
              color: ${accentColor} !important; 
              border-bottom-color: ${borderColor} !important; 
              background: ${bgColor} !important; 
            }
            .profiel-tab-btn:hover { 
              background: ${bgColor} !important; 
              color: ${accentColor} !important; 
            }
            .eigenschap-card {
              background: white;
              border: 1px solid #e5e7eb;
              border-radius: 12px;
              padding: 1rem;
              margin-bottom: 0.5rem;
              transition: all 0.2s;
            }
            .eigenschap-card:hover {
              border-color: ${borderColor};
              box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            }
            .eigenschap-header {
              display: flex;
              align-items: center;
              gap: 0.5rem;
              margin-bottom: 0.5rem;
              color: #6b7280;
              font-size: 0.9rem;
              font-weight: 500;
            }
            .eigenschap-waarde {
              font-size: 1.2rem;
              font-weight: 700;
              color: #1f2937;
            }
            .libido-hearts {
              font-size: 1.1rem;
              letter-spacing: 0.1rem;
            }
            .prestatie-item {
              background: white;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 0.5rem;
              transition: all 0.2s;
            }
            .prestatie-item:hover {
              border-color: ${borderColor};
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            }
            .prestatie-header {
              font-weight: 600;
              color: #1f2937;
              margin-bottom: 0.25rem;
            }
            .prestatie-details {
              color: #6b7280;
              font-size: 0.9rem;
            }
            .medal-item {
              display: flex;
              align-items: center;
              gap: 0.75rem;
              background: white;
              border: 1px solid #e5e7eb;
              border-radius: 8px;
              padding: 1rem;
              margin-bottom: 0.5rem;
            }
            .medal-icon {
              font-size: 1.5rem;
            }
            .medal-gold { color: #fbbf24; }
            .medal-silver { color: #9ca3af; }
            .medal-bronze { color: #d97706; }
          </style>
        `;
        
        // Tab content functies
        function renderEigenschappen() {
          return `
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:0.5rem;font-size:0.85rem;">
              <div style="background:#f8fafc;padding:0.5rem;border-radius:6px;text-align:center;">
                <div style="color:#6b7280;font-size:0.75rem;margin-bottom:0.2rem;">â¤ï¸ Libido</div>
                <div style="font-weight:600;color:#ec4899;font-size:1rem;">${'â¤ï¸'.repeat(duif.libido || 0) || 'ðŸ’”'}</div>
              </div>
              
              <div style="background:#f8fafc;padding:0.5rem;border-radius:6px;text-align:center;">
                <div style="color:#6b7280;font-size:0.75rem;margin-bottom:0.2rem;">âš¡ Snelheid</div>
                <div style="font-weight:600;color:#1f2937;font-size:1rem;">${duif.snelheid || 0}</div>
              </div>
              
              <div style="background:#f8fafc;padding:0.5rem;border-radius:6px;text-align:center;">
                <div style="color:#6b7280;font-size:0.75rem;margin-bottom:0.2rem;">ðŸ’ª Conditie</div>
                <div style="font-weight:600;color:#1f2937;font-size:1rem;">${duif.conditie || 0}</div>
              </div>
              
              <div style="background:#f8fafc;padding:0.5rem;border-radius:6px;text-align:center;">
                <div style="color:#6b7280;font-size:0.75rem;margin-bottom:0.2rem;">ðŸ§­ OriÃ«ntatie</div>
                <div style="font-weight:600;color:#1f2937;font-size:1rem;">${duif.oriÃ«ntatie || 0}</div>
              </div>
              
              <div style="background:#f8fafc;padding:0.5rem;border-radius:6px;text-align:center;">
                <div style="color:#6b7280;font-size:0.75rem;margin-bottom:0.2rem;">âš™ï¸ Techniek</div>
                <div style="font-weight:600;color:#1f2937;font-size:1rem;">${duif.techniek || 0}</div>
              </div>
              
              <div style="background:#f8fafc;padding:0.5rem;border-radius:6px;text-align:center;">
                <div style="color:#6b7280;font-size:0.75rem;margin-bottom:0.2rem;">â­ Ervaring</div>
                <div style="font-weight:600;color:#1f2937;font-size:1rem;">${duif.ervaring || 0}</div>
              </div>
              
              <div style="background:#f8fafc;padding:0.5rem;border-radius:6px;text-align:center;">
                <div style="color:#6b7280;font-size:0.75rem;margin-bottom:0.2rem;">ðŸ“ˆ Vormpeil</div>
                <div style="font-weight:600;color:#1f2937;font-size:1rem;">${duif.vormpeil || '-'}</div>
              </div>
              
              <div style="background:#f8fafc;padding:0.5rem;border-radius:6px;text-align:center;">
                <div style="color:#6b7280;font-size:0.75rem;margin-bottom:0.2rem;">ðŸŒªï¸ Aerodynamica</div>
                <div style="font-weight:600;color:#1f2937;font-size:1rem;">${duif.aerodynamica || '-'}</div>
              </div>
              
              <div style="background:#f8fafc;padding:0.5rem;border-radius:6px;text-align:center;">
                <div style="color:#6b7280;font-size:0.75rem;margin-bottom:0.2rem;">ðŸ§  Intelligentie</div>
                <div style="font-weight:600;color:#1f2937;font-size:1rem;">${duif.intelligentie || '-'}</div>
              </div>
              
              <div style="background:#f8fafc;padding:0.5rem;border-radius:6px;text-align:center;">
                <div style="color:#6b7280;font-size:0.75rem;margin-bottom:0.2rem;">ðŸŒ™ Nachtvliegen</div>
                <div style="font-weight:600;color:#1f2937;font-size:1rem;">${duif.nachtvliegen || '-'}</div>
              </div>

            </div>
          `;
        }
        
        function renderTrainingen() {
          // Filter alleen voltooide trainingen
          const voltooideTrainingen = trainingen?.filter(t => t.status === 'voltooid' && t.positie) || [];
          
          if (voltooideTrainingen.length === 0) {
            return `
              <div style="text-align:center;padding:2rem;color:#6b7280;">
                <span style="font-size:2rem;margin-bottom:1rem;opacity:0.5;">ðŸ•Šï¸</span>
                <p>Nog geen voltooide trainingsvluchten.</p>
              </div>
            `;
          }
          
          return `
            <div style="background:#f8fafc;border-radius:8px;overflow:hidden;font-size:0.85rem;">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:#e2e8f0;border-bottom:1px solid #cbd5e1;">
                    <th style="padding:0.5rem;text-align:left;font-weight:600;color:#374151;font-size:0.8rem;">Datum</th>
                    <th style="padding:0.5rem;text-align:left;font-weight:600;color:#374151;font-size:0.8rem;">Vlucht</th>
                    <th style="padding:0.5rem;text-align:center;font-weight:600;color:#374151;font-size:0.8rem;">Positie</th>
                  </tr>
                </thead>
                <tbody>
                  ${voltooideTrainingen.map(t => `
                    <tr style="border-bottom:1px solid #e2e8f0;">
                      <td style="padding:0.5rem;color:#6b7280;font-size:0.8rem;">${new Date(t.trainingsvluchten?.datum || '').toLocaleDateString('nl-NL')}</td>
                      <td style="padding:0.5rem;font-weight:500;color:#1f2937;">${t.trainingsvluchten?.naam || 'Onbekende training'}</td>
                      <td style="padding:0.5rem;text-align:center;font-weight:600;color:#059669;">${t.positie}e van ${t.aantal_deelnemers || '?'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
        
        function renderWedstrijden() {
          // Filter alleen voltooide wedstrijden
          const voltooideWedstrijden = wedstrijden?.filter(w => w.status === 'voltooid' && w.positie) || [];
          
          if (voltooideWedstrijden.length === 0) {
            return `
              <div style="text-align:center;padding:2rem;color:#6b7280;">
                <i class="fas fa-trophy" style="font-size:2rem;margin-bottom:1rem;opacity:0.5;"></i>
                <p>Nog geen voltooide wedstrijden.</p>
              </div>
            `;
          }
          
          return `
            <div style="background:#f8fafc;border-radius:8px;overflow:hidden;font-size:0.85rem;">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:#e2e8f0;border-bottom:1px solid #cbd5e1;">
                    <th style="padding:0.5rem;text-align:left;font-weight:600;color:#374151;font-size:0.8rem;">Datum</th>
                    <th style="padding:0.5rem;text-align:left;font-weight:600;color:#374151;font-size:0.8rem;">Wedstrijd</th>
                    <th style="padding:0.5rem;text-align:center;font-weight:600;color:#374151;font-size:0.8rem;">Positie</th>
                  </tr>
                </thead>
                <tbody>
                  ${voltooideWedstrijden.map(w => `
                    <tr style="border-bottom:1px solid #e2e8f0;">
                      <td style="padding:0.5rem;color:#6b7280;font-size:0.8rem;">${new Date(w.wedstrijden?.datum || '').toLocaleDateString('nl-NL')}</td>
                      <td style="padding:0.5rem;font-weight:500;color:#1f2937;">${w.wedstrijden?.naam || 'Onbekende wedstrijd'}</td>
                      <td style="padding:0.5rem;text-align:center;font-weight:600;color:#059669;">${w.positie}e van ${w.aantal_deelnemers || '?'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
        
        function renderPrijzen() {
          // Filter alleen medailles van wedstrijden (niet van trainingen)
          const wedstrijdMedailles = prijzen?.filter(p => p.bron === 'wedstrijd' || p.wedstrijd_id) || [];
          
          if (wedstrijdMedailles.length === 0) {
            return `
              <div style="text-align:center;padding:2rem;color:#6b7280;">
                <i class="fas fa-medal" style="font-size:2rem;margin-bottom:1rem;opacity:0.5;"></i>
                <p>Nog geen wedstrijdmedailles gewonnen.</p>
              </div>
            `;
          }
          
          return `
            <div style="background:#f8fafc;border-radius:8px;overflow:hidden;font-size:0.85rem;">
              <table style="width:100%;border-collapse:collapse;">
                <thead>
                  <tr style="background:#e2e8f0;border-bottom:1px solid #cbd5e1;">
                    <th style="padding:0.5rem;text-align:center;font-weight:600;color:#374151;font-size:0.8rem;">Medaille</th>
                    <th style="padding:0.5rem;text-align:left;font-weight:600;color:#374151;font-size:0.8rem;">Wedstrijd</th>
                    <th style="padding:0.5rem;text-align:left;font-weight:600;color:#374151;font-size:0.8rem;">Omschrijving</th>
                  </tr>
                </thead>
                <tbody>
                  ${wedstrijdMedailles.map(p => `
                    <tr style="border-bottom:1px solid #e2e8f0;">
                      <td style="padding:0.5rem;text-align:center;font-size:1.2rem;">
                        ${p.type === 'goud' ? 'ðŸ¥‡' : p.type === 'zilver' ? 'ðŸ¥ˆ' : 'ðŸ¥‰'}
                      </td>
                      <td style="padding:0.5rem;font-weight:500;color:#1f2937;">${p.wedstrijd_naam || 'Onbekende wedstrijd'}</td>
                      <td style="padding:0.5rem;color:#6b7280;font-size:0.8rem;">${p.omschrijving || 'Prestatie medaille'}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        }
        
        // Tab wissel logica
        function activateTab(tab) {
          document.querySelectorAll('.profiel-tab-btn').forEach(btn => btn.classList.remove('active'));
          document.getElementById('tab-' + tab).classList.add('active');
          const contentDiv = document.getElementById('profielTabContent');
          if (tab === 'eigenschappen') contentDiv.innerHTML = renderEigenschappen();
          if (tab === 'trainingen') contentDiv.innerHTML = renderTrainingen();
          if (tab === 'wedstrijden') contentDiv.innerHTML = renderWedstrijden();
          if (tab === 'prijzen') contentDiv.innerHTML = renderPrijzen();
        }
        
        document.getElementById('tab-eigenschappen').onclick = () => activateTab('eigenschappen');
        document.getElementById('tab-trainingen').onclick = () => activateTab('trainingen');
        document.getElementById('tab-wedstrijden').onclick = () => activateTab('wedstrijden');
        document.getElementById('tab-prijzen').onclick = () => activateTab('prijzen');
        
        activateTab('eigenschappen');
      } catch (err) {
        console.error('âŒ Fout bij laden profiel:', err);
        profielDiv.innerHTML = `
          <div style="text-align:center;padding:3rem 2rem;color:#ef4444;">
            <i class="fas fa-exclamation-triangle" style="font-size:2rem;margin-bottom:1rem;"></i>
            <p>Fout bij laden profiel.</p>
            <p style="font-size:0.9rem;margin-top:0.5rem;">${err.message}</p>
          </div>
        `;
      }
    };

    // Selecteer alle duiven functie
    window.selectAllDuiven = function() {
      const checkboxes = document.querySelectorAll('.duif-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = true;
      });
    }

    // Deselecteer alle duiven functie
    window.deselectAllDuiven = function() {
      const checkboxes = document.querySelectorAll('.duif-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = false;
      });
    }

    // Toon de knop alleen voor Wesley
    const { data: { user } } = await supabase.auth.getUser();
    if (user && user.email === 'wesley.wyngaerd@outlook.com') {
      document.getElementById('nieuweTrainingKnop').style.display = 'block';
    }

    // Synchroniseer simulatie data voor alle gebruikers
    async function syncSimulationData(vluchtId) {
      try {
        // Haal actuele deelnemers data op van de database
        const { data: deelnemers, error } = await supabase
          .from('trainingsvlucht_deelnames')
          .select('*, duiven!fk_duif(*, users!duiven_user_id_fkey(team_naam))')
          .eq('trainingsvlucht_id', vluchtId);
          
        if (error) {
          console.error('âŒ Fout bij synchroniseren simulatie data:', error);
          return;
        }
        
        // Update de UI met de actuele data
        if (deelnemers && deelnemers.length > 0) {
          const gesorteerdeDeelnemers = deelnemers
            .filter(d => d.duiven)
            .sort((a, b) => (b.gemiddelde_snelheid || 0) - (a.gemiddelde_snelheid || 0));
          
          updateDeelnemersTabelSync(gesorteerdeDeelnemers);
        }
      } catch (error) {
        console.error('âŒ Fout bij synchroniseren:', error);
      }
    }
    
    // Update deelnemers tabel met data
    function updateDeelnemersTabelSync(gesorteerdeDeelnemers) {
      const raceTable = document.querySelector('.race-table');
      if (raceTable && gesorteerdeDeelnemers.length > 0) {
        const tbody = raceTable.querySelector('tbody');
        if (tbody) {
          tbody.innerHTML = gesorteerdeDeelnemers.map((deelnemer, index) => {
            const percentage = ((deelnemer.huidige_afstand_gevlogen || 0) / (deelnemer.vlucht_afstand || 22)) * 100;
            const positie = index + 1;
            const medalClass = positie <= 3 ? `medal ${positie === 1 ? 'gold' : positie === 2 ? 'silver' : 'bronze'}` : '';
            const medalIcon = positie === 1 ? 'ðŸ¥‡' : positie === 2 ? 'ðŸ¥ˆ' : positie === 3 ? 'ðŸ¥‰' : '';
            return `
              <tr style="border-bottom:1px solid #e2e8f0;transition:background-color 0.2s;" onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='transparent'">
                <td class="position ${medalClass}" style="padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;font-weight:600;">${medalIcon || positie}</td>
                <td style="padding:0.4rem 0.25rem;">
                  <div class="duif-naam-cell" style="gap:0.3rem;display:flex;align-items:center;">
                    <span class="duif-geslacht-cell ${deelnemer.duiven.geslacht}" style="font-size:0.9rem;">${deelnemer.duiven.geslacht === 'man' ? 'â™‚' : 'â™€'}</span>
                    <span class="duif-naam-link" style="font-weight:600;font-size:0.85rem;color:#1f2937;cursor:pointer;text-decoration:underline;" onclick="toonDuifProfiel('${deelnemer.duif_id}')">${deelnemer.duiven.naam}</span>
                  </div>
                </td>
                <td style="padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;color:#6b7280;font-weight:500;">
                  ${deelnemer.duiven.users?.team_naam || 'Onbekend Team'}
                </td>
                <td class="speed-cell" style="color:#059669;font-weight:600;padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;">${Math.round(deelnemer.gemiddelde_snelheid || 0)} km/u</td>
                <td class="speed-cell" style="color:#3b82f6;font-weight:600;padding:0.4rem 0.25rem;text-align:center;font-size:0.8rem;">${Math.round(deelnemer.huidige_snelheid || deelnemer.gemiddelde_snelheid || 0)} km/u</td>
                <td style="font-size:0.8rem;padding:0.4rem 0.25rem;text-align:center;">${(deelnemer.huidige_afstand_gevlogen || 0).toFixed(1)} km</td>
                <td style="font-size:0.8rem;padding:0.4rem 0.25rem;text-align:center;">${(deelnemer.afstand_nog_te_gaan || 22).toFixed(1)} km</td>
                <td style="padding:0.4rem 0.25rem;">
                  <div class="progress-container" style="height:4px;background:#e2e8f0;border-radius:2px;margin-bottom:0.2rem;">
                    <div class="progress-bar" style="width: ${percentage}%;background:linear-gradient(90deg,#10b981,#059669);border-radius:2px;height:100%;"></div>
                  </div>
                  <div class="progress-text" style="font-size:0.75rem;color:#64748b;text-align:center;">${percentage.toFixed(1)}%</div>
                </td>
                <td style="font-size:0.8rem;padding:0.4rem 0.25rem;text-align:center;color:#64748b;">${calculateTime(deelnemer)}</td>
              </tr>
            `;
          }).join('');
        }
      }
    }
  </script>
</body>
</html>
